<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Yamcha's Desktop â€” Windows 95</title>
<link rel="stylesheet" href="https://unpkg.com/98.css">
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; }

  body {
    margin: 0;
    background: teal;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
    font-size: 11px;
  }

  /* â”€â”€ Desktop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #desktop {
    position: absolute;
    inset: 0 0 28px 0;
    overflow: hidden;
  }

  /* â”€â”€ Windows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .win95-window {
    position: absolute;
    min-width: 200px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    /* interact.js uses transform for dragging */
    touch-action: none;
    user-select: none;
  }
  .win95-window .window {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    margin: 0;
    /* override 98.css default margins */
  }
  .win95-window .window-body {
    flex: 1;
    overflow: auto;
    padding: 4px;
  }
  .win95-window .title-bar {
    cursor: default;
    flex-shrink: 0;
  }
  /* Inactive window */
  .win95-window.inactive .title-bar {
    background: #808080 !important;
  }
  /* Resize handle (bottom-right corner indicator) */
  .win95-window::after {
    content: '';
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 10px;
    height: 10px;
    cursor: nwse-resize;
    background: repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 2px,
      #808080 2px,
      #808080 3px
    );
    pointer-events: none;
  }
  .win95-window.maximized::after { display: none; }

  /* â”€â”€ Status Bar (98.css extension) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .status-bar {
    display: flex;
    gap: 2px;
    padding: 2px;
    flex-shrink: 0;
  }
  .status-bar-field {
    flex: 1;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  /* â”€â”€ Desktop Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .desktop-icon {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    width: 72px;
    padding: 4px;
    cursor: default;
    text-align: center;
    color: white;
    border: 1px solid transparent;
    border-radius: 0;
  }
  .desktop-icon:hover { background: rgba(0,0,128,0.4); border-color: rgba(255,255,255,0.5); }
  .desktop-icon.selected { background: #000080; border: 1px dotted white; }
  .desktop-icon img, .desktop-icon .icon-emoji {
    width: 32px; height: 32px;
    image-rendering: pixelated;
    font-size: 28px;
    line-height: 32px;
    display: block;
    text-align: center;
  }
  .desktop-icon span.label {
    font-size: 11px;
    text-shadow: 1px 1px 1px #000;
    line-height: 1.2;
    word-break: break-word;
    padding: 1px 2px;
    max-width: 72px;
  }
  .desktop-icon.selected span.label {
    background: #000080;
    outline: 1px dotted #fff;
  }

  /* â”€â”€ Taskbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #taskbar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 28px;
    background: #c0c0c0;
    border-top: 2px solid #fff;
    box-shadow: 0 -1px 0 #808080;
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 2px;
    z-index: 9000;
  }
  #taskbar-windows {
    flex: 1;
    display: flex;
    gap: 2px;
    overflow: hidden;
    height: 22px;
  }
  .taskbar-btn {
    height: 22px;
    min-width: 120px;
    max-width: 160px;
    font-size: 11px;
    text-align: left;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    padding: 0 6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .taskbar-btn.active {
    border-color: #808080 #dfdfdf #dfdfdf #808080 !important;
    background: #b4b4b4;
  }
  #systray {
    border: 2px inset #c0c0c0;
    padding: 0 8px;
    height: 22px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    background: #c0c0c0;
  }
  #clock { font-size: 11px; white-space: nowrap; }

  /* â”€â”€ Start Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #start-menu {
    position: fixed;
    bottom: 28px;
    left: 0;
    width: 200px;
    background: #c0c0c0;
    border: 2px solid;
    border-color: #fff #808080 #808080 #fff;
    box-shadow: 2px 2px 0 #000;
    z-index: 9999;
    display: none;
    flex-direction: row;
  }
  .sm-sidebar {
    background: #808080;
    color: #fff;
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-size: 15px;
    font-weight: bold;
    padding: 8px 4px;
    letter-spacing: 2px;
    white-space: nowrap;
  }
  .sm-sidebar em { color: #1084d0; font-style: normal; }
  .sm-items { flex: 1; padding: 2px 0; }
  .sm-item {
    padding: 4px 6px 4px 34px;
    cursor: default;
    position: relative;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    font-size: 12px;
  }
  .sm-item:hover { background: #000080; color: #fff; }
  .sm-item .sm-ico { position: absolute; left: 6px; font-size: 16px; }
  .sm-sep { height: 1px; background: #808080; margin: 2px 4px; border-top: 1px solid #fff; }

  /* â”€â”€ Context Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #ctx-menu {
    position: fixed;
    background: #c0c0c0;
    border: 2px solid;
    border-color: #fff #808080 #808080 #fff;
    box-shadow: 2px 2px 0 #000;
    z-index: 9998;
    display: none;
    min-width: 160px;
    padding: 2px 0;
    font-size: 12px;
  }
  .ctx-item { padding: 4px 20px; cursor: default; white-space: nowrap; }
  .ctx-item:hover { background: #000080; color: #fff; }
  .ctx-sep { height: 1px; background: #808080; margin: 2px 6px; border-top: 1px solid #fff; }

  /* â”€â”€ File Explorer internals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .explorer-wrap { display: flex; flex-direction: column; height: 100%; }
  .explorer-toolbar { display: flex; gap: 2px; padding: 2px; border-bottom: 1px solid #808080; flex-shrink: 0; }
  .explorer-addr { display: flex; align-items: center; gap: 4px; padding: 2px 4px; border-bottom: 1px solid #808080; flex-shrink: 0; }
  .explorer-addr input { flex: 1; font-size: 11px; }
  .explorer-pane { display: flex; flex: 1; overflow: hidden; }
  .tree-pane { width: 140px; border-right: 1px solid #808080; overflow-y: auto; background: #fff; font-size: 11px; flex-shrink: 0; padding: 2px; }
  .file-pane { flex: 1; overflow: auto; background: #fff; display: flex; flex-wrap: wrap; align-content: flex-start; padding: 4px; gap: 2px; }
  .file-item { display: flex; flex-direction: column; align-items: center; width: 72px; padding: 4px 2px; cursor: default; text-align: center; font-size: 11px; border: 1px solid transparent; }
  .file-item:hover { background: #000080; color: #fff; border-color: #000080; }
  .file-item.selected { background: #000080; color: #fff; }
  .file-item-icon { font-size: 24px; line-height: 28px; }
  .file-item-name { margin-top: 2px; word-break: break-all; line-height: 1.2; }
  .tree-row { padding: 1px 4px; cursor: default; display: flex; align-items: center; gap: 3px; white-space: nowrap; }
  .tree-row:hover { background: #000080; color: #fff; }

  /* â”€â”€ Notepad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notepad-body { display: flex; flex-direction: column; height: 100%; padding: 0 !important; }
  .notepad-ta { flex: 1; width: 100%; border: none; resize: none; font-family: "Courier New", monospace; font-size: 12px; padding: 4px; outline: none; background: #fff; }

  /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading { padding: 20px; text-align: center; color: #808080; font-size: 12px; }
</style>
</head>
<body>

<!-- Desktop -->
<div id="desktop"></div>

<!-- Context Menu -->
<div id="ctx-menu"></div>

<!-- Taskbar -->
<div id="taskbar">
  <button class="button" id="start-btn" onclick="toggleStartMenu(event)" style="font-weight:bold;padding:0 8px;height:22px;display:flex;align-items:center;gap:4px">
    <img src="https://win98icons.alexmeub.com/icons/png/windows-2.png" width="16" height="16" onerror="this.style.display='none'">
    <b>Start</b>
  </button>
  <div id="taskbar-windows"></div>
  <div id="systray">
    <img src="https://win98icons.alexmeub.com/icons/png/loudspeaker_rays-1.png" width="16" height="16" onerror="this.textContent='ğŸ”Š'">
    <span id="clock">12:00 AM</span>
  </div>
</div>

<!-- Start Menu -->
<div id="start-menu">
  <div class="sm-sidebar"><em>Win</em>dows 95</div>
  <div class="sm-items">
    <div class="sm-item" onclick="openExplorer('/workspace');closeStartMenu()">
      <span class="sm-ico">ğŸ“</span>File Explorer
    </div>
    <div class="sm-item" onclick="openSemfora();closeStartMenu()">
      <span class="sm-ico">ğŸ‰</span>semfora-explora
    </div>
    <div class="sm-sep"></div>
    <div class="sm-item" onclick="openNotepad('/workspace/SOUL.md');closeStartMenu()">
      <span class="sm-ico">ğŸ“„</span>SOUL.md
    </div>
    <div class="sm-item" onclick="openNotepad('/workspace/MEMORY.md');closeStartMenu()">
      <span class="sm-ico">ğŸ§ </span>MEMORY.md
    </div>
    <div class="sm-item" onclick="openNotepad('/workspace/USER.md');closeStartMenu()">
      <span class="sm-ico">ğŸ‘¤</span>USER.md
    </div>
    <div class="sm-sep"></div>
    <div class="sm-item" onclick="openAbout();closeStartMenu()">
      <span class="sm-ico">ğŸ–¥ï¸</span>About this PC
    </div>
    <div class="sm-sep"></div>
    <div class="sm-item" onclick="shutDown();closeStartMenu()">
      <span class="sm-ico">â»</span>Shut Down...
    </div>
  </div>
</div>

<script>
// â”€â”€ Win98 icon helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses alexmeub's icon pack as a CDN â€” great authentic icons
const ICON_BASE = 'https://win98icons.alexmeub.com/icons/png/';
function icon98(name, size=32) {
  return `<img src="${ICON_BASE}${name}" width="${size}" height="${size}" style="image-rendering:pixelated" onerror="this.style.display='none';this.nextSibling&&(this.nextSibling.style.display='inline')">`;
}

// â”€â”€ Desktop Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DESKTOP_ICONS = [
  { id:'mycomputer', img:'computer_explorer-4.png', fallback:'ğŸ–¥ï¸', label:'My Computer',        x:16, y:16,  action: openAbout },
  { id:'workspace',  img:'directory_open_file_mydocs-2.png', fallback:'ğŸ“', label:'Workspace',  x:16, y:104, action: () => openExplorer('/workspace') },
  { id:'semfora',    img:'directory_open-5.png', fallback:'ğŸ‰', label:'semfora-\nexplorer',     x:16, y:192, action: openSemfora },
  { id:'soul',       img:'notepad-4.png', fallback:'ğŸ“„', label:'SOUL.md',                       x:16, y:280, action: () => openNotepad('/workspace/SOUL.md') },
  { id:'memory',     img:'notepad-4.png', fallback:'ğŸ§ ', label:'MEMORY.md',                    x:16, y:368, action: () => openNotepad('/workspace/MEMORY.md') },
  { id:'recycle',    img:'recycle_bin_empty-4.png', fallback:'ğŸ—‘ï¸', label:'Recycle Bin',         x:16, y:456, action: openRecycleBin },
];

let selectedIconId = null;

function renderDesktopIcons() {
  const d = document.getElementById('desktop');
  DESKTOP_ICONS.forEach(ic => {
    const el = document.createElement('div');
    el.className = 'desktop-icon';
    el.id = 'icon-' + ic.id;
    el.style.left = ic.x + 'px';
    el.style.top  = ic.y + 'px';
    el.innerHTML = `
      <img src="${ICON_BASE}${ic.img}" width="32" height="32" style="image-rendering:pixelated" onerror="this.style.fontSize='28px';this.style.width='32px';this.style.height='32px';this.outerHTML='<span class=\\'icon-emoji\\'>${ic.fallback}</span>'">
      <span class="label">${ic.label.replace(/\n/g,'<br>')}</span>
    `;
    el.addEventListener('dblclick', ic.action);
    el.addEventListener('click', (e) => { e.stopPropagation(); selectIcon(ic.id); });
    d.appendChild(el);
  });
}
function selectIcon(id) {
  if (selectedIconId) document.getElementById('icon-'+selectedIconId)?.classList.remove('selected');
  selectedIconId = id;
  document.getElementById('icon-'+id)?.classList.add('selected');
}

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const n = new Date();
  let h = n.getHours(), m = n.getMinutes();
  const ap = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  document.getElementById('clock').textContent = `${h}:${m.toString().padStart(2,'0')} ${ap}`;
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ Window Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let winSeq = 0, activeWid = null;
const wins = {};

function nextWid() { return 'w' + (winSeq + 1); }

function createWin({ id, title, icon, width=480, height=340, x, y, bodyHtml, statusText, bodyClass }) {
  winSeq++;
  const wid = id || 'w' + winSeq;
  const cx = x ?? (60 + (winSeq % 8) * 24);
  const cy = y ?? (40 + (winSeq % 8) * 24);

  const outer = document.createElement('div');
  outer.className = 'win95-window';
  outer.id = wid;
  outer.style.cssText = `width:${width}px;height:${height}px;left:${cx}px;top:${cy}px;z-index:${1000+winSeq}`;
  outer.setAttribute('data-x', 0);
  outer.setAttribute('data-y', 0);

  const statusBarHtml = statusText !== undefined ? `
    <div class="status-bar">
      <p class="status-bar-field" id="${wid}-status">${statusText}</p>
    </div>` : '';

  outer.innerHTML = `
    <div class="window" style="width:100%;height:100%;display:flex;flex-direction:column">
      <div class="title-bar" id="${wid}-tb">
        <div class="title-bar-text" id="${wid}-title">${icon ? `<img src="${ICON_BASE}${icon}" width="14" height="14" style="vertical-align:middle;margin-right:3px;image-rendering:pixelated" onerror="this.remove()">` : ''}${title}</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize" onclick="minimizeWin('${wid}')"></button>
          <button aria-label="Maximize" onclick="toggleMaximize('${wid}')"></button>
          <button aria-label="Close" onclick="closeWin('${wid}')"></button>
        </div>
      </div>
      <div class="window-body${bodyClass?' '+bodyClass:''}" id="${wid}-body">${bodyHtml||''}</div>
      ${statusBarHtml}
    </div>
  `;

  document.getElementById('desktop').appendChild(outer);
  setupInteract(outer, wid);
  focusWin(wid);

  // Taskbar button
  const tbBtn = document.createElement('button');
  tbBtn.className = 'button taskbar-btn active';
  tbBtn.id = 'tb-' + wid;
  const tbIcon = icon ? `<img src="${ICON_BASE}${icon}" width="14" height="14" style="image-rendering:pixelated;vertical-align:middle" onerror="this.remove()">` : '';
  tbBtn.innerHTML = `${tbIcon} ${title}`;
  tbBtn.addEventListener('click', () => {
    if (outer.style.display === 'none') { outer.style.display = 'flex'; focusWin(wid); }
    else if (activeWid === wid) { minimizeWin(wid); }
    else { focusWin(wid); }
  });
  document.getElementById('taskbar-windows').appendChild(tbBtn);
  wins[wid] = { el: outer, tbBtn, maximized: false, prevCss: null };
  return wid;
}

function setupInteract(el, wid) {
  interact(el)
    .draggable({
      allowFrom: '#' + wid + '-tb',
      ignoreFrom: 'button',
      modifiers: [
        interact.modifiers.restrictRect({ restriction: '#desktop', endOnly: false })
      ],
      listeners: {
        start() { focusWin(wid); },
        move(evt) {
          if (wins[wid]?.maximized) return;
          const x = (parseFloat(el.getAttribute('data-x')) || 0) + evt.dx;
          const y = (parseFloat(el.getAttribute('data-y')) || 0) + evt.dy;
          el.style.transform = `translate(${x}px,${y}px)`;
          el.setAttribute('data-x', x);
          el.setAttribute('data-y', y);
        }
      }
    })
    .resizable({
      edges: { left: true, right: true, bottom: true, top: false },
      modifiers: [
        interact.modifiers.restrictSize({ minWidth: 200, minHeight: 100 })
      ],
      listeners: {
        start() { focusWin(wid); },
        move(evt) {
          if (wins[wid]?.maximized) return;
          const { width, height } = evt.rect;
          const { left } = evt.deltaRect;
          const x = (parseFloat(el.getAttribute('data-x')) || 0) + left;
          el.style.width  = width  + 'px';
          el.style.height = height + 'px';
          el.style.transform = `translate(${x}px,${parseFloat(el.getAttribute('data-y'))||0}px)`;
          el.setAttribute('data-x', x);
        }
      }
    });
}

function focusWin(wid) {
  Object.keys(wins).forEach(id => {
    if (wins[id]) { wins[id].el.classList.add('inactive'); wins[id].tbBtn.classList.remove('active'); }
  });
  const w = wins[wid];
  if (w) {
    w.el.classList.remove('inactive');
    w.tbBtn.classList.add('active');
    w.el.style.zIndex = 1000 + (++winSeq);
    activeWid = wid;
  }
}

function closeWin(wid) {
  const w = wins[wid]; if (!w) return;
  w.el.remove(); w.tbBtn.remove();
  delete wins[wid]; activeWid = null;
}

function minimizeWin(wid) {
  const w = wins[wid]; if (!w) return;
  w.el.style.display = 'none';
  w.tbBtn.classList.remove('active');
  activeWid = null;
}

function toggleMaximize(wid) {
  const w = wins[wid]; if (!w) return;
  const el = w.el;
  if (w.maximized) {
    el.style.cssText = w.prevCss;
    el.setAttribute('data-x', 0);
    el.setAttribute('data-y', 0);
    el.classList.remove('maximized');
    w.maximized = false;
  } else {
    w.prevCss = el.style.cssText;
    el.style.cssText = `position:absolute;left:0;top:0;width:100%;height:calc(100vh - 28px);z-index:${el.style.zIndex};transform:none`;
    el.setAttribute('data-x', 0);
    el.setAttribute('data-y', 0);
    el.classList.add('maximized');
    w.maximized = true;
  }
}

// â”€â”€ Start Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleStartMenu(e) {
  e.stopPropagation();
  const sm = document.getElementById('start-menu');
  sm.style.display = sm.style.display === 'flex' ? 'none' : 'flex';
  document.getElementById('start-btn').classList.toggle('active');
}
function closeStartMenu() {
  document.getElementById('start-menu').style.display = 'none';
  document.getElementById('start-btn').classList.remove('active');
}

// â”€â”€ Context Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctxEl = document.getElementById('ctx-menu');
function showCtx(x, y, items) {
  ctxEl.innerHTML = items.map(it => it === '-' ? '<div class="ctx-sep"></div>' : `<div class="ctx-item" onclick="${it.fn}">${it.label}</div>`).join('');
  ctxEl.style.display = 'block';
  requestAnimationFrame(() => {
    ctxEl.style.left = Math.min(x, window.innerWidth - ctxEl.offsetWidth - 4) + 'px';
    ctxEl.style.top  = Math.min(y, window.innerHeight - ctxEl.offsetHeight - 30) + 'px';
  });
}
function hideCtx() { ctxEl.style.display = 'none'; }

document.getElementById('desktop').addEventListener('contextmenu', e => {
  e.preventDefault();
  showCtx(e.clientX, e.clientY, [
    { label:'ğŸ“ Open Workspace',      fn:"openExplorer('/workspace');hideCtx()" },
    { label:'ğŸ”„ Refresh',              fn:"hideCtx()" },
    '-',
    { label:'ğŸ‰ semfora-explora',    fn:"openSemfora();hideCtx()" },
    '-',
    { label:'ğŸ–¥ï¸ About This Computer', fn:"openAbout();hideCtx()" },
  ]);
});

document.addEventListener('click', e => {
  hideCtx();
  if (!e.target.closest('#start-btn') && !e.target.closest('#start-menu')) closeStartMenu();
  if (!e.target.closest('.desktop-icon')) {
    if (selectedIconId) { document.getElementById('icon-'+selectedIconId)?.classList.remove('selected'); selectedIconId = null; }
  }
  if (!e.target.closest('.win95-window')) {
    // clicking desktop deactivates all windows visually
    Object.values(wins).forEach(w => w.el.classList.add('inactive'));
    activeWid = null;
  }
});

// â”€â”€ File Explorer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const explorerCurPath = {};

async function openExplorer(startPath = '/workspace') {
  const wid = nextWid();
  createWin({
    id: wid,
    title: 'File Explorer',
    icon: 'directory_open_file_mydocs-2.png',
    width: 620, height: 440,
    bodyHtml: `
      <div class="explorer-wrap">
        <div class="explorer-toolbar">
          <button class="button" onclick="explorerUp('${wid}')">â¬† Up</button>
          <button class="button" onclick="loadExplorer('${wid}', explorerCurPath['${wid}'])">ğŸ”„</button>
        </div>
        <div class="explorer-addr">
          <label style="font-size:11px">Address:</label>
          <input class="field-row" id="${wid}-addr" type="text" value="${startPath}" style="flex:1;font-size:11px">
          <button class="button" onclick="loadExplorer('${wid}',document.getElementById('${wid}-addr').value)">Go</button>
        </div>
        <div class="explorer-pane">
          <div class="tree-pane" id="${wid}-tree"><div class="loading">â€¦</div></div>
          <div class="file-pane" id="${wid}-files"><div class="loading">â³ Loadingâ€¦</div></div>
        </div>
      </div>
    `,
    statusText: startPath,
    bodyClass: '',
  });
  document.getElementById(wid+'-body').style.padding = '0';
  document.getElementById(wid+'-addr').addEventListener('keydown', e => {
    if (e.key === 'Enter') loadExplorer(wid, e.target.value);
  });
  explorerCurPath[wid] = startPath;
  await loadExplorer(wid, startPath);
}

async function loadExplorer(wid, path) {
  explorerCurPath[wid] = path;
  const addrEl = document.getElementById(wid+'-addr');
  if (addrEl) addrEl.value = path;
  const statusEl = document.getElementById(wid+'-status');
  if (statusEl) statusEl.textContent = path;
  const filesEl = document.getElementById(wid+'-files');
  if (!filesEl) return;
  filesEl.innerHTML = '<div class="loading">â³ Loadingâ€¦</div>';
  try {
    const res = await fetch('/api/win95/ls?path=' + encodeURIComponent(path));
    const data = await res.json();
    if (data.error) { filesEl.innerHTML = `<div class="loading">âŒ ${data.error}</div>`; return; }
    renderFilePane(wid, path, data.entries);
    renderTreePane(wid, data.tree);
    if (statusEl) statusEl.textContent = `${data.entries.length} object(s) | ${path}`;
  } catch(e) {
    filesEl.innerHTML = `<div class="loading">âŒ ${e.message}</div>`;
  }
}

function renderFilePane(wid, base, entries) {
  const el = document.getElementById(wid+'-files');
  if (!entries.length) { el.innerHTML = '<div class="loading" style="color:#aaa">Empty folder</div>'; return; }
  const bClean = base.replace(/\/+$/, '');
  el.innerHTML = entries.map(e => {
    const isDir = e.type === 'dir';
    const iconFile = isDir ? 'directory_closed-4.png' : fileIconName(e.name);
    const action = isDir
      ? `loadExplorer('${wid}','${bClean}/${e.name}')`
      : `openNotepad('${bClean}/${e.name}')`;
    return `<div class="file-item" ondblclick="${action}" title="${e.name}">
      <span class="file-item-icon">
        <img src="${ICON_BASE}${iconFile}" width="24" height="24" style="image-rendering:pixelated" onerror="this.outerHTML='${fileEmoji(e.name,isDir)}'">
      </span>
      <span class="file-item-name">${e.name}</span>
    </div>`;
  }).join('');
}

function renderTreePane(wid, tree) {
  const el = document.getElementById(wid+'-tree');
  if (!el) return;
  const bClean = (explorerCurPath[wid]||'/workspace');
  el.innerHTML = `<div class="tree-row" ondblclick="loadExplorer('${wid}','/workspace')">ğŸ“ workspace</div>` +
    (tree||[]).map(d => `<div class="tree-row" style="padding-left:14px" ondblclick="loadExplorer('${wid}','/workspace/${d}')">ğŸ“ ${d}</div>`).join('');
}

function explorerUp(wid) {
  const cur = (explorerCurPath[wid]||'/workspace').replace(/\/+$/,'');
  const parts = cur.split('/'); parts.pop();
  loadExplorer(wid, parts.join('/') || '/');
}

function fileIconName(name) {
  const ext = name.split('.').pop().toLowerCase();
  const map = {
    md:'notepad-4.png', txt:'notepad-4.png', py:'window_run-2.png',
    js:'window_run-2.png', jsx:'window_run-2.png', ts:'window_run-2.png',
    json:'notepad-4.png', html:'html-2.png', css:'paintbrush-2.png',
    sh:'window_run-2.png', sql:'database-0.png', db:'database-0.png',
    png:'picture-0.png', jpg:'picture-0.png', gif:'picture-0.png',
    svg:'picture-0.png', log:'notepad-4.png', yml:'notepad-4.png',
    yaml:'notepad-4.png', lock:'key-5.png',
  };
  return map[ext] || 'notepad_file_write-2.png';
}
function fileEmoji(name, isDir) {
  if (isDir) return 'ğŸ“';
  const ext = name.split('.').pop().toLowerCase();
  return ({md:'ğŸ“',txt:'ğŸ“„',py:'ğŸ',js:'ğŸ“œ',jsx:'âš›ï¸',json:'ğŸ“‹',html:'ğŸŒ',
           css:'ğŸ¨',sh:'âš™ï¸',sql:'ğŸ—ƒï¸',db:'ğŸ’¾',png:'ğŸ–¼ï¸',jpg:'ğŸ–¼ï¸'})[ext] || 'ğŸ“„';
}

// â”€â”€ Notepad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openNotepad(filePath) {
  const name = filePath.split('/').pop();
  const wid = nextWid();
  createWin({
    id: wid,
    title: name + ' - Notepad',
    icon: 'notepad-4.png',
    width: 560, height: 420,
    bodyHtml: `<div class="notepad-body"><textarea class="notepad-ta" id="${wid}-ta">â³ Loading ${name}â€¦</textarea></div>`,
    bodyClass: '',
    statusText: filePath,
  });
  document.getElementById(wid+'-body').style.padding = '0';
  try {
    const res = await fetch('/api/win95/cat?path=' + encodeURIComponent(filePath));
    const data = await res.json();
    const ta = document.getElementById(wid+'-ta');
    if (data.error) { ta.value = `Error: ${data.error}`; return; }
    ta.value = data.content;
    ta.readOnly = true;
    const lines = data.content.split('\n').length;
    const kb = (new Blob([data.content]).size / 1024).toFixed(1);
    const st = document.getElementById(wid+'-status');
    if (st) st.textContent = `${lines} lines | ${kb} KB | ${filePath}`;
  } catch(e) {
    const ta = document.getElementById(wid+'-ta');
    if (ta) ta.value = 'Error: ' + e.message;
  }
}

// â”€â”€ About â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openAbout() {
  const wid = nextWid();
  createWin({
    id: wid,
    title: 'About This Computer',
    icon: 'computer_explorer-4.png',
    width: 420, height: 300,
    x: Math.round(window.innerWidth/2 - 210),
    y: Math.round(window.innerHeight/2 - 150),
    bodyHtml: `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img src="${ICON_BASE}computer_explorer-4.png" width="48" height="48" style="image-rendering:pixelated;flex-shrink:0">
        <div>
          <p style="font-weight:bold;font-size:13px;margin-bottom:4px">Windows 95 â€” Yamcha Editionâ„¢</p>
          <p style="color:#555;font-size:11px;margin-bottom:8px">Your workspace desktop</p>
          <div id="${wid}-info" style="font-size:11px;line-height:1.8;color:#444">â³ Loading system infoâ€¦</div>
        </div>
      </div>
    `,
    statusText: '',
  });
  try {
    const r = await fetch('/api/win95/sysinfo');
    const d = await r.json();
    document.getElementById(wid+'-info').innerHTML = `
      <b>Host:</b> ${d.hostname||'?'}<br>
      <b>OS:</b> ${d.os||'?'}<br>
      <b>Python:</b> ${d.python||'?'}<br>
      <b>RAM:</b> ${d.ram||'?'}<br>
      <b>Disk:</b> ${d.disk_free||'?'} free<br>
      <b>Branch:</b> ${d.git_branch||'?'}<br>
      <b>Files:</b> ${d.file_count||'?'}
    `;
  } catch(e) {}
}

// â”€â”€ semfora-explora â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSemfora() {
  const wid = nextWid();
  createWin({
    id: wid,
    title: 'semfora-explora',
    icon: 'directory_open-5.png',
    width: 480, height: 280,
    bodyHtml: `
      <div style="display:flex;gap:12px;align-items:flex-start;padding:4px">
        <span style="font-size:48px;flex-shrink:0">ğŸ‰</span>
        <div>
          <p style="font-weight:bold;font-size:13px;margin-bottom:4px">semfora-explora</p>
          <p style="font-size:11px;color:#555;margin-bottom:8px">Code graph analysis &amp; visualization</p>
          <table style="font-size:11px;border-collapse:collapse;margin-bottom:10px">
            <tr><td style="color:#808080;padding-right:10px">Frontend</td><td>React 18 + Vite + react-force-graph-2d</td></tr>
            <tr><td style="color:#808080">Backend</td><td>FastAPI + SQLite + networkx</td></tr>
            <tr><td style="color:#808080">Sim</td><td>D3 physics + Z3 constraint solver</td></tr>
            <tr><td style="color:#808080">Score</td><td><b>603/603</b> users Ã— scenarios âœ…</td></tr>
            <tr><td style="color:#808080">Branch</td><td>feat/physics-improvements</td></tr>
          </table>
          <div style="display:flex;gap:6px">
            <button class="button" onclick="window.open('/','_blank')">ğŸŒ Open App</button>
            <button class="button" onclick="openExplorer('/workspace/semfora-explora')">ğŸ“ Browse</button>
            <button class="button" onclick="window.open('/simulation-report','_blank')">ğŸ“Š Sim Report</button>
          </div>
        </div>
      </div>
    `,
    statusText: 'PR #30 â€” yamchabot/semfora-explora',
  });
}

// â”€â”€ Recycle Bin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRecycleBin() {
  createWin({
    title: 'Recycle Bin',
    icon: 'recycle_bin_empty-4.png',
    width: 340, height: 200,
    bodyHtml: `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;text-align:center">
        <img src="${ICON_BASE}recycle_bin_empty-4.png" width="48" height="48" style="image-rendering:pixelated">
        <p style="font-weight:bold">Recycle Bin is empty</p>
        <p style="font-size:11px;color:#808080;font-style:italic">"trash > rm (recoverable beats gone forever)"<br>â€” AGENTS.md</p>
      </div>
    `,
    statusText: '0 objects | 0 bytes',
  });
}

// â”€â”€ Shut Down â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shutDown() {
  createWin({
    title: 'Shut Down Windows',
    width: 340, height: 160,
    x: Math.round(window.innerWidth/2-170),
    y: Math.round(window.innerHeight/2-80),
    bodyHtml: `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${ICON_BASE}shut_down-2.png" width="32" height="32" style="image-rendering:pixelated;flex-shrink:0" onerror="this.outerHTML='<span style=\\'font-size:32px\\'>â»</span>'">
        <div>
          <p style="font-weight:bold;margin-bottom:6px">Shut Down Windows</p>
          <p style="font-size:11px;color:#555">It is now safe to close your browser tab.</p>
          <p style="font-size:11px;color:#808080;margin-top:4px">â€¦just kidding, you can't actually shut this down ğŸ˜„</p>
        </div>
      </div>
    `,
    statusText: '',
  });
}

// â”€â”€ Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWelcome() {
  const wid = nextWid();
  createWin({
    id: wid,
    title: 'Welcome to Windows 95',
    icon: 'windows-2.png',
    width: 380, height: 210,
    x: Math.round(window.innerWidth/2 - 190),
    y: Math.round(window.innerHeight/2 - 105),
    bodyHtml: `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img src="${ICON_BASE}windows-2.png" width="40" height="40" style="image-rendering:pixelated;flex-shrink:0" onerror="this.outerHTML='<span style=\\'font-size:36px\\'>ğŸ‰</span>'">
        <div style="font-size:12px;line-height:1.7">
          <p style="font-weight:bold;margin-bottom:6px">Welcome, Daniel!</p>
          <p>ğŸ–¥ï¸ Double-click icons to open apps</p>
          <p>ğŸ“ File explorer browses real workspace files</p>
          <p>ğŸ–±ï¸ Right-click desktop for options</p>
          <p>â†”ï¸ Windows are draggable &amp; resizable</p>
          <p style="color:#808080;margin-top:6px;font-size:11px">Branch: feat/physics-improvements | Score: 603/603 âœ…</p>
        </div>
      </div>
    `,
    statusText: '',
  });
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderDesktopIcons();
setTimeout(showWelcome, 300);
</script>
</body>
</html>
